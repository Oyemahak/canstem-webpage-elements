# ============================================================
# CanSTEM Education - .htaccess (clean + cache-safe)
# Notes:
# - Removed the custom "s-maxage=2592000" header because it can cause stale pages
#   when you have multiple cache layers (Cloudflare + Varnish + WP Rocket).
# - Keep WP Rocket + WordPress blocks intact.
# ============================================================

# BEGIN WP Rocket
# Use UTF-8 encoding for anything served text/plain or text/html
AddDefaultCharset UTF-8

# Force UTF-8 for a number of file formats
<IfModule mod_mime.c>
  AddCharset UTF-8 .atom .css .js .json .rss .vtt .xml
</IfModule>

# Remove ETags (safer with CDNs/proxies)
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>
FileETag None

<IfModule mod_alias.c>
  <FilesMatch "\.(html|htm|rtf|rtx|txt|xsd|xsl|xml)$">
    <IfModule mod_headers.c>
      Header set X-Powered-By "WP Rocket/3.20.3"
      Header unset Pragma
      Header append Cache-Control "public"
      Header unset Last-Modified
    </IfModule>
  </FilesMatch>

  <FilesMatch "\.(css|htc|js|asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|json|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|otf|odb|odc|odf|odg|odp|ods|odt|ogg|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|tif|tiff|ttf|ttc|wav|wma|wri|xla|xls|xlsx|xlt|xlw|zip)$">
    <IfModule mod_headers.c>
      Header unset Pragma
      Header append Cache-Control "public"
    </IfModule>
  </FilesMatch>
</IfModule>

# AVIF
<IfModule mod_mime.c>
  AddType image/avif avif
  AddType image/avif-sequence avifs
</IfModule>

# Expires headers
<IfModule mod_expires.c>
  ExpiresActive on
  ExpiresDefault "access plus 1 month"
  ExpiresByType text/cache-manifest "access plus 0 seconds"
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType text/xml "access plus 0 seconds"
  ExpiresByType application/xml "access plus 0 seconds"
  ExpiresByType application/json "access plus 0 seconds"
  ExpiresByType application/rss+xml "access plus 1 hour"
  ExpiresByType application/atom+xml "access plus 1 hour"
  ExpiresByType image/x-icon "access plus 1 week"
  ExpiresByType image/gif "access plus 4 months"
  ExpiresByType image/png "access plus 4 months"
  ExpiresByType image/jpeg "access plus 4 months"
  ExpiresByType image/webp "access plus 4 months"
  ExpiresByType video/ogg "access plus 4 months"
  ExpiresByType audio/ogg "access plus 4 months"
  ExpiresByType video/mp4 "access plus 4 months"
  ExpiresByType video/webm "access plus 4 months"
  ExpiresByType image/avif "access plus 4 months"
  ExpiresByType image/avif-sequence "access plus 4 months"
  ExpiresByType text/x-component "access plus 1 month"
  ExpiresByType font/ttf "access plus 4 months"
  ExpiresByType font/otf "access plus 4 months"
  ExpiresByType font/woff "access plus 4 months"
  ExpiresByType font/woff2 "access plus 4 months"
  ExpiresByType image/svg+xml "access plus 4 months"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 month"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
</IfModule>

# Gzip compression
<IfModule mod_deflate.c>
  SetOutputFilter DEFLATE

  <IfModule mod_setenvif.c>
    <IfModule mod_headers.c>
      SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
      RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
      SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|rar|zip|exe|flv|mov|wma|mp3|avi|swf|mp?g|mp4|webm|webp|pdf)$ no-gzip dont-vary
    </IfModule>
  </IfModule>

  <IfModule mod_filter.c>
    AddOutputFilterByType DEFLATE application/atom+xml \
      application/javascript \
      application/json \
      application/rss+xml \
      application/vnd.ms-fontobject \
      application/x-font-ttf \
      application/xhtml+xml \
      application/xml \
      font/opentype \
      image/svg+xml \
      image/x-icon \
      text/css \
      text/html \
      text/plain \
      text/x-component \
      text/xml
  </IfModule>

  <IfModule mod_headers.c>
    Header append Vary: Accept-Encoding
  </IfModule>
</IfModule>
# END WP Rocket

# BEGIN WordPress
# The directives (lines) between "BEGIN WordPress" and "END WordPress" are
# dynamically generated, and should only be modified via WordPress filters.
# Any changes to the directives between these markers will be overwritten.
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# MalCare WAF
<Files ".user.ini">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order deny,allow
    Deny from all
  </IfModule>
</Files>
# END MalCare WAF